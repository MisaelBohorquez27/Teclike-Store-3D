generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

/*
  Enums para valores controlados
*/
enum OrderStatus {
  PENDING    // Orden creada, esperando pago
  APPROVED   // Pago aprobado por Payphone
  REJECTED   // Pago rechazado
  CANCELLED  // Cancelado por el usuario
  PAID       // Alias de APPROVED (legacy)
  SHIPPED    // Orden enviada
  DELIVERED  // Orden entregada
  REFUNDED   // Reembolsado
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum OfferType {
  PERCENTAGE
  FIXED
}

enum RoleType {
  ADMIN
  CUSTOMER
}

enum OfferRecurrence {
  NONE
  DAILY
  WEEKLY
  MONTHLY
  ANNUAL
}

/*
  Models
*/

model Product {
  id          Int      @id @default(autoincrement())
  brand       String
  slug        String   @unique
  sku         String? 
  name        String
  description String?
  priceCents  Int
  currency    String   @default("USD")
  imageUrl    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  inventory        Inventory?
  categoryProducts CategoryProduct[]
  offerProducts    OfferProduct[]
  orderItems       OrderItem[]
  cartProducts     CartProduct[]
  reviews          Review[]
  images           ProductImage[]

  @@map("products")
}

model Order {
  id                      Int          @id @default(autoincrement())
  userId                  Int
  clientTransactionId     String       @unique // ID único de nuestra transacción
  payphoneTransactionId   String?      // ID de Payphone
  subtotalCents           Int
  taxCents                Int
  shippingCostCents       Int
  totalCents              Int
  shippingAddress         String?
  billingAddress          String?
  email                   String?
  phone                   String?
  status                  OrderStatus  @default(PENDING)
  paymentMethod           String?      // VISA, MASTERCARD, etc.
  lastFourDigits          String?      // Últimos 4 dígitos de la tarjeta
  orderDate               DateTime     @default(now())
  updatedAt               DateTime     @updatedAt

  // Relations
  user         User          @relation(fields: [userId], references: [id])
  items        OrderItem[]
  payments     Payment[]

  @@index([userId])
  @@index([clientTransactionId])
  @@map("orders")
}

model OrderItem {
  id         Int      @id @default(autoincrement())
  productId  Int
  orderId    Int
  quantity   Int
  priceCents Int
  createdAt  DateTime @default(now())

  // Relations
  product Product @relation(fields: [productId], references: [id])
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@map("order_items")
}

model Cart {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade) // Asegura eliminación en cascada
  cartProducts CartProduct[]

  @@index([userId]) // Ya tienes @unique, pero por si acaso
  @@map("carts")
}

model CartProduct {
  id        Int      @id @default(autoincrement())
  cartId    Int
  productId Int
  quantity  Int      @default(1)
  priceCents Int     
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade) 

  @@unique([cartId, productId])
  @@index([cartId])
  @@map("cart_products")
}

model Category {
  id               Int               @id @default(autoincrement())
  name             String
  description      String?
  slug             String            @unique

  // Relations
  categoryProducts CategoryProduct[]

  @@map("categories")
}

model CategoryProduct {
  id          Int    @id @default(autoincrement())
  categoryId  Int
  productId   Int
  description String?

  // Relations
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([categoryId, productId])
  @@map("category_products")
}

model Offer {
  id         Int             @id @default(autoincrement())
  name       String          @unique
  type       OfferType
  value      Int
  startDate  DateTime
  endDate    DateTime
  recurrence OfferRecurrence @default(NONE)

  // Relations
  offerProducts OfferProduct[]

  @@map("offers")
}

model OfferProduct {
  id        Int @id @default(autoincrement())
  offerId   Int
  productId Int

  // Relations
  offer   Offer   @relation(fields: [offerId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@unique([offerId, productId])
  @@map("offer_products")
}

model Review {
  id         Int      @id @default(autoincrement())
  userId     Int
  productId  Int
  comment    String
  rating     Int
  reviewDate DateTime @default(now())

  // Relations
  user    User    @relation(fields: [userId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@map("reviews")
}

model User {
  id             Int     @id @default(autoincrement())
  role           RoleType @default(CUSTOMER)         
  photoURL       String?
  username       String  @unique
  phone          String?
  email          String  @unique
  password       String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  orders        Order[]
  cart          Cart?         // 1:1 (cada usuario tiene 1 carrito activo)
  reviews       Review[]
  payments      Payment[]
  userAddresses UserAddress[]

  @@map("users")
}

model Payment {
  id              Int           @id @default(autoincrement())
  paymentMethodId Int
  orderId         Int?
  userId          Int?
  transactionId   String
  paymentDate     DateTime @default(now())
  amountCents     Int
  status          PaymentStatus @default(PENDING)

  // Relations
  paymentMethod PaymentMethod @relation(fields: [paymentMethodId], references: [id])
  order         Order?        @relation(fields: [orderId], references: [id])
  user          User?         @relation(fields: [userId], references: [id])

  @@map("payments")
}

model PaymentMethod {
  id     Int    @id @default(autoincrement())
  method String @unique

  // Relations
  payments Payment[]

  @@map("payment_methods")
}

model Address {
  id                Int     @id @default(autoincrement())
  street            String
  city              String
  country           String
  postalCode        String?
  additionalDetails String?

  // Relations
  userAddresses UserAddress[]

  @@map("addresses")
}

model UserAddress {
  id        Int @id @default(autoincrement())
  userId    Int
  addressId Int

  // Relations
  user    User    @relation(fields: [userId], references: [id])
  address Address @relation(fields: [addressId], references: [id])

  @@unique([userId, addressId])
  @@map("user_addresses")
}

model Inventory {
  id        Int      @id @default(autoincrement())
  productId Int      @unique
  stock     Int
  isNew     Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  product Product @relation(fields: [productId], references: [id])

  @@map("inventory")
}
model ProductImage {
  id        Int    @id @default(autoincrement())
  productId Int
  imageUrl  String
  imageAlt  String?
  createdAt DateTime @default(now())

  // Relations
  product Product @relation(fields: [productId], references: [id])

  @@map("image_products")
}
